# Kafka Kubernetes Setup - Reference

Complete reference for deploying and managing Kafka on Kubernetes.

## Configuration Options

### Helm Values

Key Bitnami Kafka chart values:

| Value | Default | Description |
|-------|---------|-------------|
| `replicaCount` | 1 | Number of Kafka brokers |
| `zookeeper.replicaCount` | 1 | Number of Zookeeper nodes |
| `persistence.size` | 8Gi | Persistent volume size |
| `autoCreateTopicsEnable` | false | Auto-create topics |
| `offsetsTopicReplicationFactor` | 1 | Replication for internal topics |

### Production Settings

For production deployments:

```bash
./scripts/deploy.sh --replicas 3 --storage 100Gi
```

Recommended:
- Minimum 3 brokers for high availability
- Minimum 100Gi storage for production workloads
- Configure resource limits

## Topic Configuration

### Partition Count

Guidelines for partition count:
- Development: 1-3 partitions
- Production: 3-10 partitions
- High throughput: 10+ partitions

Formula: `partitions = max(consumer_group_size, throughput_per_partition)`

### Replication Factor

- Development: 1
- Production: 3 (requires â‰¥3 brokers)

## Troubleshooting

### Pods Not Starting

Check pod status:
```bash
kubectl get pods -n kafka -o wide
kubectl describe pod -n kafka <pod-name>
```

Common issues:
- Insufficient resources: Increase CPU/memory limits
- Storage issues: Check PVC status
- Image pull issues: Check image name and registry

### Connection Issues

Test from within cluster:
```bash
kubectl run -it --rm kafka-client --image=confluentinc/cp-kafka:latest --namespace=kafka --restart=Never -- bash

# Inside pod
kafka-broker-api-versions --bootstrap-server kafka.kafka.svc.cluster.local:9092
```

### Topic Already Exists

The `create-topic.sh` script uses `--if-not-exists`, so it's safe to run multiple times.

## Security

### SASL Authentication

For production, enable SASL:

```bash
helm install kafka bitnami/kafka \
  --set auth.sasl.enabled=true \
  --set auth.sasl.interBrokerUser=user \
  --set auth.sasl.interBrokerPassword=password
```

### TLS/SSL

Enable TLS:

```bash
helm install kafka bitnami/kafka \
  --set tls.enabled=true \
  --set tls.autoGenerated=true
```

## Monitoring

### JMX Metrics

Enable JMX for monitoring:

```bash
helm install kafka bitnami/kafka \
  --set jmx.enabled=true
```

### Prometheus Exporter

Add Kafka Exporter:

```bash
helm install kafka-exporter prometheus-community/kafka-exporter \
  --namespace kafka \
  --set kafka.servers=kafka.kafka.svc.cluster.local:9092
```

## Backup and Recovery

### Backup Topics

List all topics:
```bash
kubectl exec -n kafka kafka-0 -- kafka-topics.sh --list --bootstrap-server localhost:9092 > topics.txt
```

Backup topic configs:
```bash
kubectl exec -n kafka kafka-0 -- kafka-topics.sh --describe --topic <topic> --bootstrap-server localhost:9092
```

## LearnFlow Topics

Standard topic configuration:

| Topic | Partitions | Replication | Retention |
|-------|------------|-------------|----------|
| learning.requests | 3 | 1 | 7 days |
| code.submissions | 3 | 1 | 30 days |
| exercise.generated | 1 | 1 | 7 days |
| struggle.detected | 1 | 1 | 30 days |
