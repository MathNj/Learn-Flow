#!/usr/bin/env node
/**
 * {{ description }}
 *
 * Generated by mcp-code-execution skill.
 * MCP Server: {{ mcp_server }}
 * Tool: {{ tool }}
 * Language: javascript
 */

{% if use_mcp_sdk %}
// MCP client imports
import { Client } from '@modelcontextprotocol/sdk/client/index.js';
import { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';
{% endif %}

/**
 * Call an MCP server tool.
 * @param {string} serverName - Name of the MCP server
 * @param {string} toolName - Name of the tool to call
 * @param {Object} params - Parameters for the tool call
 * @returns {Promise<any>} Tool result data
 */
async function callMcpServer(serverName, toolName, params) {
    {% if use_mcp_sdk %}
    const transport = new StdioClientTransport({
        command: 'npx',
        args: [serverName]
    });

    const client = new Client({
        name: 'wrapper-client',
        version: '1.0.0'
    }, {
        capabilities: {}
    });

    await client.connect(transport);

    const result = await client.callTool({
        name: toolName,
        arguments: params
    });

    await client.close();

    // Parse content from result
    if (result.content && result.content[0]) {
        return JSON.parse(result.content[0].text);
    }

    return result;
    {% else %}
    // Placeholder for MCP server call
    // Replace with actual MCP client implementation
    throw new Error('MCP client integration required');
    {% endif %}
}

/**
 * Filter data based on expression.
 * @param {Array} data - List of items to filter
 * @param {string} filterExpr - Optional filter expression
 * @returns {Array} Filtered list of items
 */
function filterData(data, filterExpr = null) {
    if (!filterExpr) {
        return data;
    }

    // Simple filter implementation
    // Supports: key==value, key!=value patterns
    if (filterExpr.includes('==')) {
        const [key, value] = filterExpr.split('==').map(s => s.trim().replace(/['"]/g, ''));
        return data.filter(item => item[key] === value);
    }

    if (filterExpr.includes('!=')) {
        const [key, value] = filterExpr.split('!=').map(s => s.trim().replace(/['"]/g, ''));
        return data.filter(item => item[key] !== value);
    }

    return data;
}

/**
 * Transform data based on expression.
 * @param {Array} data - List of items to transform
 * @param {string} transformExpr - Optional transform expression
 * @returns {Array} Transformed list of items
 */
function transformData(data, transformExpr = null) {
    if (!transformExpr) {
        return data;
    }

    // Apply transformations (placeholder for actual implementation)
    return data;
}

/**
 * Main function.
 */
async function main() {
    const args = process.argv.slice(2);

    // Default values
    const config = {
        server: '{{ mcp_server }}',
        tool: '{{ tool }}',
        filter: null,
        transform: null,
        limit: {{ limit | default(10) }},
        {% for arg in tool_args %}
        {{ arg.name }}: {{ arg.default | to_json }},
        {% endfor %}
    };

    // Parse arguments
    for (let i = 0; i < args.length; i++) {
        switch (args[i]) {
            case '--server':
                config.server = args[++i];
                break;
            case '--tool':
                config.tool = args[++i];
                break;
            case '--filter':
                config.filter = args[++i];
                break;
            case '--transform':
                config.transform = args[++i];
                break;
            case '--limit':
                config.limit = parseInt(args[++i], 10);
                break;
{% for arg in tool_args %}
            case '--{{ arg.name }}':
                config.{{ arg.name }} = args[++i];
                break;
{% endfor %}
            case '-h':
            case '--help':
                console.log(getHelp());
                process.exit(0);
            default:
                console.error(`Unknown option: ${args[i]}`);
                console.error('Use --help for usage information');
                process.exit(2);
        }
    }

    // Validate required arguments
    {% for arg in tool_args %}
    {% if arg.required %}
    if (!config.{{ arg.name }}) {
        console.error(JSON.stringify({
            status: 'error',
            message: '{{ arg.name }} is required. Use --help for usage information.'
        }));
        process.exit(2);
    }
    {% endif %}
    {% endfor %}

    try {
        // Build tool parameters
        const toolParams = {
            {% for arg in tool_args %}
            {{ arg.param_name }}: config.{{ arg.name }},
            {% endfor %}
        };

        // Call MCP server
        let data = await callMcpServer(config.server, config.tool, toolParams);

        // Ensure data is an array
        if (!Array.isArray(data)) {
            data = [data];
        }

        // Apply filter
        if (config.filter) {
            data = filterData(data, config.filter);
        }

        // Apply transform
        if (config.transform) {
            data = transformData(data, config.transform);
        }

        // Apply limit
        const results = data.slice(0, config.limit);

        // Output results
        const output = {
            status: 'success',
            count: results.length,
            total: data.length,
            data: results
        };

        console.log(JSON.stringify(output));
        process.exit(0);

    } catch (error) {
        console.error(JSON.stringify({
            status: 'error',
            message: error.message,
            errorType: error.constructor.name
        }));
        process.exit(1);
    }
}

/**
 * Generate help text.
 */
function getHelp() {
    return `Usage: ${process.argv[1]} [OPTIONS]

{{ description }}

Options:
    --server NAME       MCP server name (default: {{ mcp_server }})
    --tool NAME         Tool name (default: {{ tool }})
    --filter EXPR       Filter expression for results
    --transform EXPR    Transform expression for results
    --limit N           Maximum results to return (default: {{ limit | default(10) }})
{% for arg in tool_args %}
    --{{ arg.name }}    {{ arg.help }}{% if arg.default %} (default: {{ arg.default }}){% endif %}{% if arg.required %} [required]{% endif %}
{% endfor %}
    -h, --help          Show this help message

Environment Variables:
    MCP_SERVER          Default MCP server name
    MCP_TOOL            Default tool name

Examples:
    # Basic usage
    node script.js --sheet-id abc123

    # With filter and limit
    node script.js --sheet-id abc123 --filter 'status=="pending"' --limit 5

    # With custom server
    node script.js --server custom-mcp --tool getData --limit 20
`;
}

// Run main if this file is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
    main().catch(error => {
        console.error(JSON.stringify({
            status: 'error',
            message: error.message,
            errorType: 'FatalError'
        }));
        process.exit(1);
    });
}

// Export functions for testing
export { callMcpServer, filterData, transformData, main };
