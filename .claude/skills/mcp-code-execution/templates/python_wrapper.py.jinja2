#!/usr/bin/env python3
"""
{{ description }}

Generated by mcp-code-execution skill.
MCP Server: {{ mcp_server }}
Tool: {{ tool }}
Language: python
"""

import argparse
import json
import sys
from typing import Any, Dict, List

{% if use_mcp_client %}
# MCP client imports
try:
    from mcp_client import Client
except ImportError:
    print(json.dumps({
        "status": "error",
        "message": "mcp-client not installed. Run: pip install mcp-client"
    }), file=sys.stderr)
    sys.exit(1)
{% endif %}


def call_mcp_server(server_name: str, tool_name: str, params: Dict[str, Any]) -> Any:
    """
    Call an MCP server tool.

    Args:
        server_name: Name of the MCP server
        tool_name: Name of the tool to call
        params: Parameters for the tool call

    Returns:
        Tool result data
    """
    {% if use_mcp_client %}
    client = Client()
    result = client.call_tool(tool_name, params)
    return result
    {% else %}
    # Placeholder for MCP server call
    # Replace with actual MCP client implementation
    raise NotImplementedError("MCP client integration required")
    {% endif %}


def filter_data(data: List[Any], filter_expr: str = None) -> List[Any]:
    """
    Filter data based on expression.

    Args:
        data: List of items to filter
        filter_expr: Optional filter expression

    Returns:
        Filtered list of items
    """
    if not filter_expr:
        return data

    {% if allow_eval %}
    # Safe eval for simple expressions
    import re
    # Convert common patterns to Python
    # e.g., "status=='pending'" -> lambda x: x.get("status")=="pending"
    if "==" in filter_expr:
        key, value = filter_expr.split("==", 1)
        key = key.strip()
        value = value.strip().strip('"\'')
        return [item for item in data if item.get(key) == value]
    elif "!=" in filter_expr:
        key, value = filter_expr.split("!=", 1)
        key = key.strip()
        value = value.strip().strip('"\'')
        return [item for item in data if item.get(key) != value]
    {% endif %}

    return data


def transform_data(data: List[Any], transform_expr: str = None) -> List[Any]:
    """
    Transform data based on expression.

    Args:
        data: List of items to transform
        transform_expr: Optional transform expression

    Returns:
        Transformed list of items
    """
    if not transform_expr:
        return data

    # Apply transformations (placeholder for actual implementation)
    return data


def main():
    """Main entry point for the wrapper script."""
    parser = argparse.ArgumentParser(
        description="{{ description }}",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    # MCP server arguments
    parser.add_argument(
        "--server",
        default="{{ mcp_server }}",
        help="MCP server name"
    )
    parser.add_argument(
        "--tool",
        default="{{ tool }}",
        help="MCP tool name"
    )

    # Data processing arguments
    parser.add_argument(
        "--filter",
        dest="filter_expr",
        default=None,
        help="Filter expression (e.g., 'status==\"pending\"')"
    )
    parser.add_argument(
        "--transform",
        dest="transform_expr",
        default=None,
        help="Transform expression"
    )
    parser.add_argument(
        "--limit",
        type=int,
        default={{ limit | default(10) }},
        help="Maximum number of results to return"
    )

    # Tool-specific arguments
    {% for arg in tool_args %}
    parser.add_argument(
        "--{{ arg.name }}",
        {{ arg.required | default(false) | to_json }},
        default={{ arg.default | to_json }},
        help="{{ arg.help }}"
    )
    {% endfor %}

    args = parser.parse_args()

    try:
        # Build tool parameters
        tool_params = {
            {% for arg in tool_args %}
            "{{ arg.param_name }}": getattr(args, "{{ arg.name }}"),
            {% endfor %}
        }

        # Call MCP server
        data = call_mcp_server(args.server, args.tool, tool_params)

        # Ensure data is a list
        if not isinstance(data, list):
            data = [data]

        # Apply filter
        if args.filter_expr:
            data = filter_data(data, args.filter_expr)

        # Apply transform
        if args.transform_expr:
            data = transform_data(data, args.transform_expr)

        # Apply limit
        results = data[:args.limit]

        # Output results
        output = {
            "status": "success",
            "count": len(results),
            "total": len(data) if args.limit > len(data) else "limited",
            "data": results
        }
        print(json.dumps(output))

        sys.exit(0)

    except KeyboardInterrupt:
        print(json.dumps({"status": "cancelled", "message": "Operation cancelled"}))
        sys.exit(130)
    except Exception as e:
        print(json.dumps({
            "status": "error",
            "message": str(e),
            "error_type": type(e).__name__
        }), file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
