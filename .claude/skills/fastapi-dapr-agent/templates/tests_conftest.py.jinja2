"""
Pytest configuration and fixtures for {{ service_name }}.
"""
import pytest
from typing import AsyncGenerator, Generator
from fastapi.testclient import TestClient
from httpx import AsyncClient, ASGITransport

from app.main import app


@pytest.fixture
def client() -> Generator:
    """Sync test client fixture."""
    with TestClient(app) as c:
        yield c


@pytest.fixture
async def async_client() -> AsyncGenerator:
    """Async test client fixture."""
    async with AsyncClient(
        transport=ASGITransport(app=app),
        base_url="http://test"
    ) as ac:
        yield ac


@pytest.fixture
def mock_dapr_state(monkeypatch):
    """Mock Dapr state store."""
    class MockState:
        async def get(self, key):
            return None

        async def save(self, key, value, etag=None):
            return "mock-etag"

        async def delete(self, key, etag=None):
            pass

    from app.services import state
    monkeypatch.setattr(state, "state", MockState())
    return MockState()


@pytest.fixture
def mock_dapr_publisher(monkeypatch):
    """Mock Dapr event publisher."""
    class MockPublisher:
        published_events = []

        async def publish(self, topic, data, retries=3, backoff_ms=100):
            self.published_events.append((topic, data))
            return True

    from app.services import publisher
    mock = MockPublisher()
    monkeypatch.setattr(publisher, "publisher", mock)
    return mock
