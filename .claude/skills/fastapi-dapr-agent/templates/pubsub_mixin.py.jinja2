"""
Dapr pub/sub subscriber handlers for {{ service_name }}.
"""
import logging
from typing import Callable, Dict, Any

from fastapi import FastAPI
from dapr.ext.fastapi import DaprApp

log = logging.getLogger(__name__)


# Dapr app wrapper
dapr_apps: Dict[str, DaprApp] = {}


def get_dapr_app(app: FastAPI) -> DaprApp:
    """Get or create DaprApp for FastAPI app."""
    app_id = id(app)
    if app_id not in dapr_apps:
        dapr_apps[app_id] = DaprApp(app)
    return dapr_apps[app_id]


def register_subscribers(app: FastAPI):
    """
    Register all pub/sub subscribers for the service.

    Topics:
{% for topic in topics %}
    {% if topic.subscribe %}    - {{ topic.name }}{% endif %}
{% endfor %}
    """
    dapr_app = get_dapr_app(app)

{% for topic in topics %}
{% if topic.subscribe %}
    @dapr_app.subscribe(pubsub_name="kafka-pubsub", topic="{{ topic.name }}")
    async def handle_{{ topic.name.replace('.', '_').replace('-', '_') }}(event_data: Dict[str, Any]):
        """Handle {{ topic.name }} event."""
        log.info(f"Received event from {{ topic.name }}: {event_data.get('event_id')}")

        # Process event
        # TODO: Add your business logic here

        return {"status": "processed", "event_id": event_data.get("event_id")}

{% endif %}
{% endfor %}
    log.info("Pub/sub subscribers registered")
